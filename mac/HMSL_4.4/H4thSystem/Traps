\ Trap 68000 Exceptions\\ Author: Phil Burk\ Copyright 1990\\ MOD: PLB 10/11/90 UNRAVEL  c/30/50/ , remove call to TRAPSANEW TASK-TRAPSdecimalvariable DEBUG-TRAPS: UNRAVEL  ( -- , show names on stack )	>newline ." Calling sequence:"    r0 @ rp@ - cell/ 2+	50 min 0	DO  4 spaces		r0 @ i cell* - @ dup >name ?dup		IF id. drop		ELSE .hex		THEN cr?	LOOP cr;: HANDLE.GROUP0  ( -- , group 0 exception , address and bus errors )    ." For 68000 processors:" cr	."   Exception generated at: $"	rp@ $ 0A + @ dup .hex dup 1 and 0=	IF ." in " >name id. cr	ELSE drop	THEN	."   Attempt to access: $"	rp@ 2+ @ dup .hex cr cr\    ." For 68020 processors:" cr	."   Exception generated at: $"	rp@ 2+ @ dup .hex dup 1 and 0=	IF ." in " >name id. cr	ELSE drop	THEN	."   Attempt to access: $"	rp@ $ 10 @ dup .hex cr cr\	rdrop rdrop rdrop wr> drop\	unravel .s	debug-traps @	IF debugger()	THEN	." Stack cleared!    OK" cr	abort;: HANDLE.GROUP1,2  ( -- , group 1 or 2 exception , illegal ins)    ." 680x0 Exception generated at: $"	rp@ 2+ @ dup .hex ." in " >name id. cr cr\	rdrop wr> drop\	unravel .s	debug-traps @	IF debugger()	THEN	." Stack cleared!    OK" cr	abort;: TRAP.BUS  ( -- , respond to error )    cr ." Bus Error - " handle.group0;: TRAP.ADDRESS  ( -- , respond to error )    cr ." Address Error - " handle.group0;: TRAP.ILLEGAL  ( -- , respond to error )    cr ." ILLEGAL Instruction - " handle.group1,2;variable IF-TRAPSvariable OLD-BUS-TRAPvariable OLD-ADDRESS-TRAPvariable OLD-ILLEGAL-TRAP: TRAPS.ON  ( -- )    if-traps @ 0=	IF	8 @ old-bus-trap !   'c trap.bus 8 !  ( bus error )		12 @ old-address-trap !  'c trap.address 12 !  ( address error )		16 @ old-illegal-trap !  'c trap.illegal 16 !  ( illegal instruction error )		if-traps on		." TRAPs installed!" cr	THEN;: TRAPS.OFF  ( -- , turn traps off )	if-traps @	IF  old-bus-trap @ 8 !		old-address-trap @ 12 !		old-illegal-trap @ 16 !		if-traps off		." TRAPs removed." cr	THEN;if.forgotten TRAPS.OFF: AUTO.INIT auto.init traps.on ;: AUTO.TERM traps.off auto.term ;false .IF: UNR1 11 . unravel 11 . ;: UNR2 22 . unr1 22 . ;: UNR3 33 . unr2 33 . ;: ILLEGAL  ( -- illegal instruction )    [ $ 4AFC w, ];: ILL1 illegal ;: ILL2 ill1 ;: BAD@ 0 . 3 @ ;: BAD1 1 . bad@ ;: BAD2 2 . bad1 ;.THEN